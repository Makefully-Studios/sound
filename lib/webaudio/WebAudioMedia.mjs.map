{"version":3,"file":"WebAudioMedia.mjs","sources":["../../src/webaudio/WebAudioMedia.ts"],"sourcesContent":["import { DOMAdapter } from 'pixi.js';\r\nimport { Filter } from '../filters/Filter';\r\nimport { IMedia } from '../interfaces/IMedia';\r\nimport { LoadedCallback, Sound } from '../Sound';\r\nimport { WebAudioContext } from './WebAudioContext';\r\nimport { WebAudioInstance } from './WebAudioInstance';\r\nimport { WebAudioNodes } from './WebAudioNodes';\r\n\r\n/**\r\n * Represents a single sound element. Can be used to play, pause, etc. sound instances.\r\n * @memberof webaudio\r\n */\r\nclass WebAudioMedia implements IMedia\r\n{\r\n    /**\r\n     * Reference to the parent Sound container.\r\n     * @readonly\r\n     */\r\n    public parent: Sound;\r\n\r\n    /**\r\n     * The file buffer to load.\r\n     * @readonly\r\n     */\r\n    public source: ArrayBuffer | AudioBuffer;\r\n\r\n    /** Instance of the chain builder. */\r\n    private _nodes: WebAudioNodes;\r\n\r\n    /**\r\n     * Raw audio file data.\r\n     */\r\n    public file: Blob;\r\n\r\n    /** Instance of the source node. */\r\n    private _source: AudioBufferSourceNode;\r\n\r\n    /**\r\n     * Re-initialize without constructing.\r\n     * @param parent - - Instance of parent Sound container\r\n     */\r\n    public init(parent: Sound): void\r\n    {\r\n        this.parent = parent;\r\n        this._nodes = new WebAudioNodes(this.context);\r\n        this._source = this._nodes.bufferSource;\r\n        this.source = parent.options.source as ArrayBuffer | AudioBuffer;\r\n    }\r\n\r\n    /** Destructor, safer to use `SoundLibrary.remove(alias)` to remove this sound. */\r\n    public destroy(): void\r\n    {\r\n        this.parent = null;\r\n        this._nodes.destroy();\r\n        this._nodes = null;\r\n        try\r\n        {\r\n            this._source.buffer = null;\r\n        }\r\n        catch (err)\r\n        {\r\n            // try/catch workaround for bug in older Chrome versions\r\n            console.warn('Failed to set AudioBufferSourceNode.buffer to null:', err);\r\n        }\r\n        this._source = null;\r\n        this.source = null;\r\n    }\r\n\r\n    // Implement create\r\n    public create(): WebAudioInstance\r\n    {\r\n        return new WebAudioInstance(this);\r\n    }\r\n\r\n    // Implement context\r\n    public get context(): WebAudioContext\r\n    {\r\n        return this.parent.context as WebAudioContext;\r\n    }\r\n\r\n    // Implement isPlayable\r\n    public get isPlayable(): boolean\r\n    {\r\n        return !!this._source && !!this._source.buffer;\r\n    }\r\n\r\n    // Implement filters\r\n    public get filters(): Filter[]\r\n    {\r\n        return this._nodes.filters;\r\n    }\r\n    public set filters(filters: Filter[])\r\n    {\r\n        this._nodes.filters = filters;\r\n    }\r\n\r\n    // Implements duration\r\n    public get duration(): number\r\n    {\r\n        // eslint-disable-next-line no-console\r\n        console.assert(this.isPlayable, 'Sound not yet playable, no duration');\r\n\r\n        return this._source.buffer.duration;\r\n    }\r\n\r\n    /** Gets and sets the buffer. */\r\n    public get buffer(): AudioBuffer\r\n    {\r\n        return this._source.buffer;\r\n    }\r\n    public set buffer(buffer: AudioBuffer)\r\n    {\r\n        this._source.buffer = buffer;\r\n    }\r\n\r\n    /** Get the current chained nodes object */\r\n    public get nodes(): WebAudioNodes\r\n    {\r\n        return this._nodes;\r\n    }\r\n\r\n    // Implements load\r\n    public load(callback?: LoadedCallback): void\r\n    {\r\n        // Load from the arraybuffer, incase it was loaded outside\r\n        if (this.source)\r\n        {\r\n            this._decode(this.source, callback);\r\n        }\r\n        // Load from the file path\r\n        else if (this.parent.url)\r\n        {\r\n            this._loadUrl(callback);\r\n        }\r\n        else if (callback)\r\n        {\r\n            callback(new Error('sound.url or sound.source must be set'));\r\n        }\r\n        else\r\n        {\r\n            console.error('sound.url or sound.source must be set');\r\n        }\r\n    }\r\n\r\n    /** Loads a sound using XHMLHttpRequest object. */\r\n    private async _loadUrl(callback?: LoadedCallback): Promise<void>\r\n    {\r\n        const url: string = this.parent.url;\r\n        const response = await DOMAdapter.get().fetch(url);\r\n        const arrayBuffer = await response.arrayBuffer();\r\n        \r\n        this.file = new Blob([arrayBuffer]);\r\n        this._decode(arrayBuffer, callback);\r\n    }\r\n\r\n    /**\r\n     * Decodes the array buffer.\r\n     * @param arrayBuffer - From load.\r\n     * @param {Function} callback - Callback optional\r\n     */\r\n    private _decode(arrayBuffer: ArrayBuffer | AudioBuffer, callback?: LoadedCallback): void\r\n    {\r\n        const audioBufferReadyFn = (err: Error, buffer: AudioBuffer) =>\r\n        {\r\n            if (err)\r\n            {\r\n                if (callback)\r\n                {\r\n                    callback(err);\r\n                }\r\n            }\r\n            else\r\n            {\r\n                this.parent.isLoaded = true;\r\n                this.buffer = buffer;\r\n                const instance = this.parent.autoPlayStart();\r\n\r\n                if (callback)\r\n                {\r\n                    callback(null, this.parent, instance);\r\n                }\r\n            }\r\n        };\r\n\r\n        if (arrayBuffer instanceof AudioBuffer)\r\n        {\r\n            audioBufferReadyFn(null, arrayBuffer);\r\n        }\r\n        else\r\n        {\r\n            const context = this.parent.context as WebAudioContext;\r\n\r\n            context.decode(arrayBuffer, audioBufferReadyFn);\r\n        }\r\n    }\r\n}\r\n\r\nexport { WebAudioMedia };\r\n"],"names":[],"mappings":"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"}