{"version":3,"file":"HTMLAudioMedia.js","sources":["../../src/htmlaudio/HTMLAudioMedia.ts"],"sourcesContent":["import { EventEmitter } from 'pixi.js';\r\nimport { Filter } from '../filters/Filter';\r\nimport { IMedia } from '../interfaces/IMedia';\r\nimport { LoadedCallback, Sound } from '../Sound';\r\nimport { HTMLAudioContext } from './HTMLAudioContext';\r\nimport { HTMLAudioInstance } from './HTMLAudioInstance';\r\n\r\n/**\r\n * The fallback version of Sound which uses `<audio>` instead of WebAudio API.\r\n * @memberof htmlaudio\r\n * @extends PIXI.EventEmitter\r\n */\r\nclass HTMLAudioMedia extends EventEmitter implements IMedia\r\n{\r\n    public parent: Sound;\r\n    private _source: HTMLAudioElement;\r\n\r\n    public init(parent: Sound): void\r\n    {\r\n        this.parent = parent;\r\n        this._source = parent.options.source as HTMLAudioElement || new Audio();\r\n        if (parent.url)\r\n        {\r\n            this._source.src = parent.url;\r\n        }\r\n    }\r\n\r\n    // Implement create\r\n    public create(): HTMLAudioInstance\r\n    {\r\n        return new HTMLAudioInstance(this);\r\n    }\r\n\r\n    /**\r\n     * If the audio media is playable (ready).\r\n     * @readonly\r\n     */\r\n    public get isPlayable(): boolean\r\n    {\r\n        return !!this._source && this._source.readyState === 4;\r\n    }\r\n\r\n    /**\r\n     * THe duration of the media in seconds.\r\n     * @readonly\r\n     */\r\n    public get duration(): number\r\n    {\r\n        return this._source.duration;\r\n    }\r\n\r\n    /**\r\n     * Reference to the context.\r\n     * @readonly\r\n     */\r\n    public get context(): HTMLAudioContext\r\n    {\r\n        return this.parent.context as HTMLAudioContext;\r\n    }\r\n\r\n    /** The collection of filters, does not apply to HTML Audio. */\r\n    public get filters(): Filter[]\r\n    {\r\n        return null;\r\n    }\r\n    public set filters(_filters: Filter[])\r\n    {\r\n        console.warn('HTML Audio does not support filters');\r\n    }\r\n\r\n    // Override the destroy\r\n    public destroy(): void\r\n    {\r\n        this.removeAllListeners();\r\n\r\n        this.parent = null;\r\n\r\n        if (this._source)\r\n        {\r\n            this._source.src = '';\r\n            this._source.load();\r\n            this._source = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the audio source element.\r\n     * @type {HTMLAudioElement}\r\n     * @readonly\r\n     */\r\n    public get source(): HTMLAudioElement\r\n    {\r\n        return this._source;\r\n    }\r\n\r\n    // Implement the method to being preloading\r\n    public load(callback?: LoadedCallback): void\r\n    {\r\n        const source = this._source;\r\n        const sound = this.parent;\r\n\r\n        // See if the source is already loaded\r\n        if (source.readyState === 4)\r\n        {\r\n            sound.isLoaded = true;\r\n            const instance = sound.autoPlayStart();\r\n\r\n            if (callback)\r\n            {\r\n                setTimeout(() =>\r\n                {\r\n                    callback(null, sound, instance);\r\n                }, 0);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        // If there's no source, we cannot load\r\n        if (!sound.url)\r\n        {\r\n            callback(new Error('sound.url or sound.source must be set'));\r\n\r\n            return;\r\n        }\r\n\r\n        // Set the source\r\n        source.src = sound.url;\r\n\r\n        const onLoad = () =>\r\n        {\r\n            // eslint-disable-next-line @typescript-eslint/no-use-before-define\r\n            removeListeners();\r\n            sound.isLoaded = true;\r\n            const instance = sound.autoPlayStart();\r\n\r\n            if (callback)\r\n            {\r\n                callback(null, sound, instance);\r\n            }\r\n        };\r\n\r\n        const onAbort = () =>\r\n        {\r\n            // eslint-disable-next-line @typescript-eslint/no-use-before-define\r\n            removeListeners();\r\n            if (callback)\r\n            {\r\n                callback(new Error('Sound loading has been aborted'));\r\n            }\r\n        };\r\n\r\n        const onError = () =>\r\n        {\r\n            // eslint-disable-next-line @typescript-eslint/no-use-before-define\r\n            removeListeners();\r\n            const message = `Failed to load audio element (code: ${source.error.code})`;\r\n\r\n            if (callback)\r\n            {\r\n                callback(new Error(message));\r\n            }\r\n            else\r\n            {\r\n                console.error(message);\r\n            }\r\n        };\r\n\r\n        // Remove all event listeners\r\n        const removeListeners = () =>\r\n        {\r\n            // Listen for callback\r\n            source.removeEventListener('canplaythrough', onLoad);\r\n            source.removeEventListener('load', onLoad);\r\n            source.removeEventListener('abort', onAbort);\r\n            source.removeEventListener('error', onError);\r\n        };\r\n\r\n        // Listen for callback\r\n        source.addEventListener('canplaythrough', onLoad, false);\r\n        source.addEventListener('load', onLoad, false);\r\n        source.addEventListener('abort', onAbort, false);\r\n        source.addEventListener('error', onError, false);\r\n\r\n        // Begin the loading\r\n        source.load();\r\n    }\r\n}\r\n\r\nexport { HTMLAudioMedia };\r\n"],"names":["EventEmitter","HTMLAudioInstance"],"mappings":"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"}